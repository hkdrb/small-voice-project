# システムアーキテクチャ

## 概要
本プロジェクト "Small Voice" は、組織内の様々な「小さな声」データを収集・分析し、改善アクションを促進するための **AI搭載型社内ブロードリスニングシステム** です。

開発プロジェクトの振り返り、技術的負債やコード品質に関するフィードバック、開発環境への要望アンケートなどのテキストデータを入力とし、Google Gemini APIを活用して自動的に分類・感情分析・課題抽出を行い、組織が次の一手を打つためのインサイトを提供します。

## 主な機能
1.  **AI分析レポート生成**:
    *   大量のテキストデータを自動分類し、意味的な類似度マップを生成。
    *   全体傾向の要約、解決すべき重要課題、アクションプランを自動生成。
2.  **インタラクティブ・ダッシュボード**:
    *   プロット図（散布図）による意見の全体像の把握。
    *   Google Plotlyを用いたズーム・パン操作。
3.  **アンケート作成・収集**:
    *   **フォーム作成申請 (Workflow)**:
        一般メンバーが組織改善のためのアンケート案を管理者に提案できるボトムアップ機能です。

        | 物理状態 (`approval_status` / `is_active`) | 管理者表示 | 申請者表示 | 詳細説明 |
        | :--- | :--- | :--- | :--- |
        | `pending` / `False` | **申請中** | **申請中** | 申請直後の初期状態。管理者が内容を審査します。 |
        | `approved` / `False` | **停止中** | **承認済み** | 承認されたが非公開。管理者が公開操作を行うまでこの状態です。 |
        | `approved` / `True` | **公開中** | (非表示*) | 全ユーザーへ公開中。*申請者は「回答」タブで確認可能になります。 |
        | `rejected` / `False` | **却下** | **却下** | 差し戻し状態。申請者が内容を修正して「再申請」することが可能です。 |

    *   **承認フローのライフサイクル**:
        1.  **申請**: 一般ユーザーがフォームを作成して送信。
        2.  **承認/却下**: 管理者が `Check`（承認）か `X`（却下）を選択。承認時は一度「停止中」に入ります。
        3.  **公開管理**: 承認済みのフォームに対し、管理者が `Eye`（公開）アイコンを押すことで全体公開が始まります。
    *   システム内でアンケートフォームを作成・公開し、回答データを直接蓄積・分析可能。
    *   **CSVインポート**: 外部CSVデータを「フォーム」として取り込み、統一的な分析フローで処理。
4.  **解決策チャットボード**:
    *   分析結果に対してメンバーがコメントや解決策を投稿・議論するフォーラム機能。
    *   **スレッド形式のリプライ**や**いいネ機能**により、活発な議論を促進。
    *   AIによる「議論のまとめ」機能。
5.  **マルチテナント (組織管理)**:
    *   ユーザーとデータを「組織」単位で分離。
    *   システム全体管理者と各組織管理者の階層的な権限モデル。

## 技術スタック
- **Frontend**: [Next.js](https://nextjs.org/) (App Router, React 19)
- **Styling**: Tailwind CSS, Lucide React
- **Backend / API**: [FastAPI](https://fastapi.tiangolo.com/) (Python 3.10+)
- **Database**: PostgreSQL
- **ORM**: SQLAlchemy
- **AI/LLM**: 
    - **Google Gemini 2.0 Flash Thinking Exp**: 複雑な分析タスク（課題抽出、深層分析）に使用。推論特化モデル。
    - **Google Gemini 2.0 Flash Exp**: 軽量タスク（クラスター命名、要約）に使用。高速処理。
- **機械学習・分析**:
    - **Sentence Transformers**: 多言語対応BERTモデル（paraphrase-multilingual-MiniLM-L12-v2）による意味ベクトル化。
    - **K-Means**: 非階層クラスタリングによるグルーピング。
    - **Isolation Forest + LOF**: 外れ値検出アルゴリズムによる「Small Voice」スコアリング。
    - **UMAP**: 非線形次元削減による高精度な2次元マップ座標の算出。
- **認証**: Cookieベースのセッション管理 (Database-backed), Bcryptハッシュ化

## AI分析・アルゴリズム詳細

本システムでは、「多数決で埋もれる意見」を救い上げるために、独自のプロンプトエンジニアリングと数理的手法を組み合わせています。

### 1. 「小さな声（外れ値）」の検出ロジック
単なるアンケート集計（平均値）ではなく、**「件数は少ないが重要な意見」**を拾うために以下のルールをAIに強制しています。

*   **ユニークな提案の別枠抽出**:
    *   分析プロンプト内で、全体の傾向（Key Trends）とは別に、**`notable_ideas`（具体的でユニークな提案）**という枠を設け、独自性のある意見を強制的に抽出させています。
*   **リスク情報の強制昇格**:
    *   「バグ」「重い」「エラー」きいったシステム品質に関わるキーワードが含まれる場合、**たとえ1件であっても**「システム品質リスク」として重要課題リストに掲載するよう、プロンプトで制御しています。
*   **可視化による発見**:
    *   K-Means法とPCA（主成分分析）により、意見の分布を2次元マップ化します。大多数の意見（クラスタ）から物理的に離れた位置にあるドット（外れ値）は視覚的に目立つため、ユーザーが直感的に「異質な意見」に気づけるようになっています。

### 2. 日本語のニュアンスと感情分析
日本企業特有の「控えめな表現」を正しく解釈するためのルールを定めています。

*   **「丁寧な不満」の検知**:
    *   「〜してほしいのですが」「〜だと助かります」といった表現は、ポジティブではなく**ネガティブ（スコア -0.3 〜 -0.7）**として判定するよう定義しています。これにより、表面上の丁寧さに隠れた現場のSOSを検知します。

### 3. 分析プロセスフロー
1.  **意味ベクトル化 (Sentence Transformers)**: 多言語BERTモデルにより、テキストを384次元の意味ベクトルに変換。文脈や意味的類似性を高精度で捉えます。
2.  **クラスタリング (K-Means)**: 意味の近い意見をグループ化。
3.  **外れ値検出 (Isolation Forest + LOF)**: 2つの異常検知アルゴリズムを組み合わせ、各意見に「Small Voice スコア」を付与。少数だが重要な意見を定量的に特定します。
4.  **次元削減 (UMAP)**: 高次元の意味空間を2次元に投影し、散布図にプロット。PCAより意味的な配置精度が高く、類似した意見が近くに配置されます。
5.  **LLMによる深層解釈**:
    *   **軽量タスク (Gemini 2.0 Flash)**: 各クラスタの内容を要約し、適切なタグ（カテゴリ名）を付与。
    *   **深層分析 (Gemini 2.0 Flash Thinking)**: Chain of Thought推論により、クラスタ間の関係性や重要課題を言語化。Small Voiceスコアの高い意見を優先的に分析。

## ディレクトリ構造
```
small-voice-project/
├── backend/                # Backend Application (FastAPI)
│   ├── api/                # API Endpoints (Routers)
│   │   ├── auth.py         # 認証関連
│   │   ├── survey.py       # アンケート管理
│   │   ├── dashboard.py    # ダッシュボードデータ
│   │   └── ...
│   ├── database.py         # DBモデル定義 & 接続
│   ├── services/           # ビジネスロジック・AI分析
│   │   ├── analysis.py
│   │   └── email_service.py
│   └── main.py             # Entry Point
├── frontend/               # Frontend Application (Next.js)
│   ├── src/
│   │   ├── app/            # App Router Pages
│   │   ├── components/     # UI Components
│   │   └── lib/            # Utility functions (API client, etc.)
│   └── package.json
├── alembic/                # DBマイグレーション設定
├── docs/                   # プロジェクトドキュメント
└── outputs/                # 生成データ出力先
```

## コンポーネント詳細

### Backend (`backend/`)
- **`main.py`**: アプリケーションのエントリーポイント。CORS設定やルーターの登録を行います。
- **`api/`**: RESTful APIのエンドポイントを定義します。Frontendからのリクエストを受け付け、Service層やDatabase層を呼び出します。
- **`services/`**: AI分析ロジック (Sentence Transformers, K-Means, UMAP, Isolation Forest/LOF, Gemini API) やメール機能等のビジネスロジックを集約しています。

### Frontend (`frontend/`)
- **`src/app/`**: ページルーティングを担当します。
    - `/login`: ログインページ
    - `/dashboard`: メインダッシュボード
    - `/surveys`: アンケート管理
- **`src/components/`**: 再利用可能なUIコンポーネント。グラフ描画には `react-plotly.js` を使用しています。

### Database
- **`database.py`**: SQLAlchemyモデル (`User`, `Organization`, `Survey` 等) の定義と、DBセッション管理を提供します。

### Generate Test Data
- **`scripts/generate_test_data.py`**: デモ用のCSVデータを生成します。エンジニア組織を想定したデータ（価値観、プロジェクト管理、開発環境、技術品質）が生成されます。生成されたデータは `outputs/test_data/` に保存され、API経由でインポート可能です。
